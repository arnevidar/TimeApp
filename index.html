<!DOCTYPE html>
<html>
  <head>
    <title>FileReader Example</title>

    <link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.0.css" />
	<script type="text/javascript" charset="utf-8" src="js/jquery-1.7.1.js"></script>
	<script type="text/javascript" charset="utf-8" src="js/jquery.mobile-1.0.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/phonegap-1.3.0.js"></script>
	<script type="text/javascript" charset="utf-8">

    // Wait for PhoneGap to load
    //
    
    document.addEventListener("deviceready", onDeviceReady, false);
	$(window).bind("scrollstop", function() {
		$.mobile.fixedToolbars.show(100);
	});


	var TIMEAPPFOLDER = 'TimeApp';

    // PhoneGap is ready
    //
    function onDeviceReady() {
		checkAndCreateTimeAppFolder();
    }
    
    function checkAndCreateTimeAppFolder() {
	  window.requestFileSystem(LocalFileSystem.PERSISTENT, 0.2*1024*1024, function (fileSystem) { 
        fileSystem.root.getDirectory(TIMEAPPFOLDER, {create: true}, function (dirEntry) {
    	}, fail); 
	  }, fail);    
    }
    
    
    function readDirectoryEntries(onSuccess, onFailure) {
 	  window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function (fileSystem) { 
        fileSystem.root.getDirectory(TIMEAPPFOLDER, {create: true}, function (dirEntry) {
          var dirReader = dirEntry.createReader();
          dirReader.readEntries(onSuccess, onFailure);        
    	}, fail); 
	  }, fail);       
    }


     function populateList() {
	 $("#contentlist").empty(); //empty the list elements we've placed in the html
	 readDirectoryEntries(populateListpart2, fail);
          
          //repopulate the list with data from phonegap's device api

          //$("#contentlist").append("<li><a href='#'>Device Name: "     +device.name+     "</a></li>");
     }
     
     function populateListpart2(filelist) {
       var i;
       for (i = 0; i<filelist.length; i++) {
       $("#contentlist").append("<li><a href='#'>File: "     +filelist[i].name+     "</a></li>");  
       }
     }


	function writefile(filename, content) {
	  window.requestFileSystem(LocalFileSystem.PERSISTENT, 0.2*1024*1024, function (fileSystem) { // henter filsystem
        fileSystem.root.getFile(TIMEAPPFOLDER+"/"+filename, {create: true}, function (fileEntry) {
          fileEntry.createWriter(function (writer) {
  		    writer.onwrite = function(evt) {
              console.log("write success");
        	};
        	console.log("Path " + fileEntry.fullPath);
        	writer.write(content);
    	  }, fail);
    	}, fail); 
	  }, fail);
    }
    
    function readfile(filename, handler) {
            window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function (fileSystem) {
	        		fileSystem.root.getFile(TIMEAPPFOLDER+"/"+filename, {create: true}, function (fileEntry) {
 		       		  fileEntry.file(function gotFile(file){
					    var reader = new FileReader();
					      reader.onloadend = function(evt) {
					        console.log("Read as text");
				    	    console.log(evt.target.result)
				        	handler(reader.result);
				       	  };
				        reader.readAsText(file);
    				  }, fail);
    			  }, fail);
    		}, fail);

    }

	 var punchcard = {"punch": [
        {"date": 1, "company": "Intern", "project": "Vacation", "confirmed": 0},
        {"date": 2, "company": "DNB", "project": "SOAP", "confirmed": 1},
        {"date": 3, "company": "Intern", "project": "Training", "confirmed": 0}
    	]
	 };
	 
	 function dance(result){
	   //var json = JSON.parse(result);     
	   $("#jsontest").append("hei " + result);
	 
	 }

     function fail(error) {
     // TODO Gi beskjed hvis man ikke får skrevet data til fil
        console.log("Error: "+error.code);
     }	

     function beepbeep() {


	 
		punchcard.punch[0].company = "Børge schi |'17/a";
		var start = new Date().getTime();
     //   for (int i = 0; i<1000; i++) {
        var jsonString = JSON.stringify(punchcard);
		
		writefile("test.txt", jsonString);
		var jsonTest = JSON.parse(jsonString);
		readfile("test.txt", dance);
        
        // }
        var elapsed = new Date().getTime() - start;
        $("#jsontest").append(jsonTest.punch[0].company + " tok " + elapsed);

     }
        
    </script>
  </head>
  <body>
     <div data-role="page"> 

          <div data-role="header" data-position="fixed"> 

               <h1> Header Content </h1>

          </div>

          <div data-role="content"> 

               <p> Main Page Content </p>
                    <a href="#contentpage" data-role="button" onClick=populateList()> To the List Page!</a>

    				<a href="#" data-role="button" id="beepbtn" onClick=beepbeep()> Beep!</a>
    				
    				     <p id="jsontest">
                                aa
                          </p>

          <ul data-role="listview" data-theme="g" id="contentlist">
          </ul>

          </div>

          <div data-role="footer" data-position="fixed"> 

               <h1> Footer Content </h1>

          </div>

     </div>
  </body>
</html>

