<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Register hours</title>
    <link rel="stylesheet" type="text/css" href="../css/jquery.mobile-1.0.css" />
    <link rel="stylesheet" type="text/css" href="http://dev.jtsage.com/cdn/datebox/latest/jquery.mobile.datebox.min.css" />
    <link rel="stylesheet" type="text/css" href="http://dev.jtsage.com/cdn/simpledialog/latest/jquery.mobile.simpledialog.min.css" />
    <link rel="stylesheet" type="text/css" href="http://dev.jtsage.com/cdn/datebox/latest/jquery.mobile.datebox.min.css" />

    <script type="text/javascript" charset="utf-8" src="../js/jquery-1.7.1.js"></script>
    <script type="text/javascript" charset="utf-8" src="../js/jquery.mobile-1.0.js"></script>
    <script type="text/javascript" charset="utf-8" src="../js/problemdomain.js"></script>
    <script type="text/javascript" charset="utf-8" src="../js/jquery.mobile.simpledialog.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="../js/mobiscroll-1.5.3.js"></script>
    <script type="text/javascript" src="http://dev.jtsage.com/cdn/datebox/latest/jquery.mobile.datebox.min.js"></script>
    <script type="text/javascript" charset="utf-8">


        var tadc = new TimeAppDataController();
        tadc.loadData();

        $("#new_company_link").live("click", function() {
            $(this).simpledialog({
                'mode' : 'string',
                'prompt' : 'Add a new company',
                'useDialogForceFalse' : true,
                'buttons' : {
                    'OK': {
                        click: function () {
                            var newOption = $("#new_company_link").attr('data-string').trim();
                            if(newOption !== "") {
                                $('<option value="'+newOption+'" selected="selected">'+newOption+'</option>').appendTo($("#select_company"));
                                $("#select_company").selectmenu('refresh');
                                $("#select_company").trigger('change');
                            } else {
                                alert("Not a valid company name");
                            }

                        }
                    },
                    'Cancel': {
                        click: function () { },
                        icon: "delete",
                        theme: "c"
                    }
                }
            })
        });

        $("#new_description_link").live('click', function() {
            $(this).simpledialog({
                'mode' : 'string',
                'prompt' : 'Add a new description',
                'useDialogForceFalse' : true,
                'buttons' : {
                    'OK': {
                        click: function () {
                            var newOption = $("#new_description_link").attr('data-string').trim();
                            if(newOption !== "") {
                                $('<option value="'+newOption+'" selected="selected">'+newOption+'</option>').appendTo($("#select_description"));
                                $("#select_description").selectmenu('refresh');
                                $("#select_description").trigger('change');
                            } else {
                                alert("Not a valid description");
                            }
                        }
                    },
                    'Cancel': {
                        click: function () { },
                        icon: "delete",
                        theme: "a"
                    }
                }
            })
        });

        $("#add_details").live("pageinit", function() {
            var last7UsedCompanies = tadc.get7companies();
            $("#select_company").children('option').remove();
            $('<option data-placeholder="Company">Company</option>').appendTo($("#select_company"));
            $('<option value="new_company_option">Add a new company</option>').appendTo($("#select_company"));
            $('<option value="Internal">Internal</option>').appendTo($("#select_company"));
            for(var i = 0; i < last7UsedCompanies.length; i++) {
                $('<option value="'+last7UsedCompanies[i] +'" selected="selected">'+last7UsedCompanies[i]+'</option>').appendTo($("#select_company"));
                $("#select_company").selectmenu('refresh');
            }
            $("#select_company option")[0].selected = true;
            $("#select_company").selectmenu('refresh');
        });



        $("#select_company").live("change", function() {
            var companyName = $("#select_company option:selected").text();
            if(companyName === "Add a new company") {
                $("#new_company_link").click();
            }
            else if(companyName !== "Company") {
                get7LastDescriptions(companyName);
            }
        });


        $("#add_details").live("pageinit", function() {
            $("#first_day_after_vacation").scroller({preset : 'date',
                onSelect: function(valueText, inst) {
                    $("#save_hours_btn").removeClass("ui-disabled ");

                },
                beforeShow: function(input, inst) {

                }
            })
        });


        $("#add_details").live("pageinit", function() {
            var Adate = new Date(0,0,0,0,0,0,0);
            $("#hours_and_minutes").scroller({ preset: 'time', hourText: 'Hours',minuteText:'Minutes',
                stepMinute: 15, ampm: false, mode: 'clickpick', timeFormat : 'HH:ii',
                onSelect: function(valueText, inst) {
                    $("#save_hours_btn").removeClass("ui-disabled ");
                }
            });
            $("#hours_and_minutes").scroller('setDate', Adate, true);
        });


        function get7LastDescriptions(companyName) {
            var descriptions = tadc.get7descriptions(companyName);
            $("#select_description").children('option').remove();
            $('<option data-placeholder="Description">Description</option>').appendTo($("#select_description"));
            $('<option value="new_description_option">Add new description</option>').appendTo($("#select_description"));
            if(descriptions !== null) {
                for(var i = 0; i < descriptions.length; i++) {
                    $('<option value="' + descriptions[i] + '" selected="selected">' + descriptions[i] + '</option>').appendTo($("#select_description"));
                    $("#select_description").selectmenu('refresh');
                }

            }
            $('#select_description').val("Description").selectmenu('refresh');
        }



        $("#select_description").live("change", function() {
            var desc = $("#select_description option:selected").text();
            if(desc === "Day off" || desc === "Time off") {
                $("#hours_and_minutes").show();
                $("#first_day_after_vacation").hide();
                var fullDay = new Date();
                fullDay.setHours(7);
                fullDay.setMinutes(30);
                $("#hours_and_minutes").scroller('setDate', fullDay, true);
                $("#hours_and_minutes").scroller('destroy');
                $("#save_hours_btn").removeClass("ui-disabled ");
            } else if(desc === "Add new description") {
                $("#new_description_link").click();
            } else if(desc === "Vacation") {
                $("#hours_and_minutes").hide();
                $("#first_day_after_vacation").show();
            } else {
                $("#first_day_after_vacation").hide();
                $("#hours_and_minutes").prop("disabled", false).show();
            }
        });

        function pushData(formObject) {
            var company = $("#select_company option:selected").text();
            var description = $("#select_description option:selected").text();
            if(company !== "Vacation") {
                var number_of_hours = formatTime($("#hours_and_minutes").val());
                tadc.updatePunch(company, description, todaysDate, number_of_hours);
            } else {
                var dateAfterVacation = $("#first_day_after_vacation").val();
            }


            //alert(number_of_hours);

            //addMockLine(jsonString);
            //resetFormValues();
        }

        function formatTime(time) {
            var hours = time.slice(0,2);
            var minutes = time.slice(3,5);
            var formatedMinues = 0;
            if(hours.slice(0,1) == 0) {
                alert(hours);
                hours = hours.slice(1,2);
            }
            switch(minutes) {
                case '15':
                    formatedMinues = 25;
                    break;
                case '30':
                    formatedMinues = 5;
                    break;
                case '45':
                    formatedMinues = 75;
                    break;
            }
            alert(hours);
            return hours + "." + formatedMinues;
        }

        function resetFormValues() {
            $('#select_company').val("Company").selectmenu('refresh');
            $('#select_description').val('Description').selectmenu('refresh');
            //   $("#select_company").change();


        }

    </script>

</head>

<body>

    <div data-role="page" id="add_details">
        <div data-role="content">
            <form id="details_to_add">
                <div data-role="fieldcontain">
                    <select id="select_company" data-native-menu="false" value="Company">
                    </select>

                    <select id="select_description" data-native-menu="false" value="Description">
                    </select>

                    <input type="text" id="hours_and_minutes" placeholder="Hours and minutes" disabled="true"/>
                    <input id="first_day_after_vacation" type="date" placeholder="First day after vacation"
                           style="display: none;"/>
                </div>
                <div data-role="controlgroup" data-type="horizontal">
                    <a href="#" data-role="button" data-rel="back">Close</a>
                    <a href="#" data-role="button" id="save_hours_btn" data-rel="back" class="ui-disabled" onclick="pushData()">Save</a>
                </div>
            </form>
            <a href="#" id="new_description_link" style="display : none;"></a>
            <a id="new_company_link" href="#" style="display: none;"></a>
            <a id="vacation_date" href="#" style="display: none;"></a>
            <a href="#" data-role="button" value="clear" onclick="resetFormValues()">Clear</a>
        </div>

        <!--Add footer from script -->
        <script type="text/javascript" src="../win7phone_js/navbar_win_add_hours.js"></script>
    </div>


</body>
</html>