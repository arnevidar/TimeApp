<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <title>Register hours</title>
        <script type="text/javascript" charset="utf-8" src="js/phonegap-1.4.0.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/jquery-1.7.1.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/jquery.mobile-1.0.js"></script>

        <link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.0.css" />
        <link rel="stylesheet" type="text/css" href="css/mobiscroll-1.5.3.css"/>
        <link rel="stylesheet" type="text/css" href="css/timeapp.css"/>
        <link rel="stylesheet" type="text/css" href="css/jquery.mobile.simpledialog.min.css" />
        <link rel="stylesheet" type="text/css" href="css/jquery.mobile.datebox.css" />


        <script type="text/javascript" charset="utf-8" src="js/problemdomain.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/persistence.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/jquery.mobile.simpledialog.min.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/mobiscroll-1.5.3.js"></script>

        <script type="text/javascript" charset="utf-8" src="js/statusbarnotification.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/jquery.mobile.datebox.js"></script>
        <script type="text/javascript">

            function onDeviceReady() {
             //   $(window).bind("scrollstop", function() {
             //       $.mobile.fixedToolbars.show(true);
             //   });
            }

            var todaysDate = new Date();
            var tadc = new TimeAppDataController();
            tadc.loadData(function() {}, function() {});


            $.mobile.changePage.defaults.allowSamePageTransition = true;

            $("#register_hours").live("pageinit", function() {
                $("#mydate").bind('datebox', function (e, passed) {
                    if ( passed.method === 'set' ) {
                        changeToSelectedDay(passed.date);
                    }
                });
            });

            $("#new_company_link").live("click", function() {
                $(this).simpledialog({
                    'mode' : 'string',
                    'prompt' : 'Add a new company',
                    'useDialogForceFalse' : true,
                    'buttons' : {
                        'OK': {
                            click: function () {
                                var newOption = $("#new_company_link").attr('data-string').trim();
                                if(newOption !== "") {
                                    $('<option value="'+newOption+'" selected="selected">'+newOption+'</option>').appendTo($("#select_company"));
                                    $("#select_company").selectmenu('refresh');
                                    $("#select_company").trigger('change');
                                } else {
                                    alert("Not a valid company name");
                                }

                            }
                        },
                        'Cancel': {
                            click: function () { },
                            icon: "delete",
                            theme: "c"
                        }
                    }
                })
            });

            $("#new_description_link").live('click', function() {
                $(this).simpledialog({
                    'mode' : 'string',
                    'prompt' : 'Add a new description',
                    'useDialogForceFalse' : true,
                    'buttons' : {
                        'OK': {
                            click: function () {
                                var newOption = $("#new_description_link").attr('data-string').trim();
                                if(newOption !== "") {
                                    $('<option value="'+newOption+'" selected="selected">'+newOption+'</option>').appendTo($("#select_description"));
                                    $("#select_description").selectmenu('refresh');
                                    $("#select_description").trigger('change');
                                } else {
                                    alert("Not a valid description");
                                }
                            }
                        },
                        'Cancel': {
                            click: function () { },
                            icon: "delete",
                            theme: "a"
                        }
                    }
                })
            });

            $("#add_details").live("pageinit", function() {
                var last7UsedCompanies = tadc.get7companies();
                $("#select_company").children('option').remove();
                $('<option data-placeholder="Company">Company</option>').appendTo($("#select_company"));
                $('<option value="new_company_option">Add a new company</option>').appendTo($("#select_company"));
                $('<option value="Internal">Internal</option>').appendTo($("#select_company"));
                for(var i = 0; i < last7UsedCompanies.length; i++) {
                    $('<option value="'+last7UsedCompanies[i] +'" selected="selected">'+last7UsedCompanies[i]+'</option>').appendTo($("#select_company"));
                    $("#select_company").selectmenu('refresh');
                }
                $("#select_company option")[0].selected = true;
                $("#select_company").selectmenu('refresh');
            });



            $("#select_company").live("change", function() {
                var companyName = $("#select_company option:selected").text();
                if(companyName === "Add a new company") {
                    $("#new_company_link").click();
                }
                else if(companyName !== "Company") {
                    get7LastDescriptions(companyName);
                }
            });



            function printDate() {
                document.write(todaysDate.toDateString());
            }

            $("#register_hours").live("swipeleft swiperight", function(event) {
                var direction = false;
                event.preventDefault();
                var nextDay = 0;
                if(event.type == "swipeleft") {
                    //show next day
                   nextDay = +1;
                } else if(event.type == "swiperight") {
                    //show previous day
                    direction = true;
                    nextDay = -1;
                }
                changeDay(nextDay, direction);
            });

            $("#add_details").live("pageinit", function() {
                $("#notifyTime").scroller({preset : 'time'});
                var newDate = new Date();
                $("#notifyTime").scroller('setDate', newDate, true);
            });


            $("#add_details").live("pageinit", function() {
                $("#first_day_after_vacation").scroller({preset : 'date',
                    onSelect: function(valueText, inst) {
                        $("#save_hours_btn").removeClass("ui-disabled ");

                    },
                    beforeShow: function(input, inst) {

                    }
                })
            });


            $("#add_details").live("pageinit", function() {
                var Adate = new Date(0,0,0,0,0,0,0);
                $("#hours_and_minutes").scroller({ preset: 'time', hourText: 'Hours',minuteText:'Minutes',
                    stepMinute: 15, ampm: false, timeFormat : 'HH:ii',
                    onSelect: function(valueText, inst) {
                        $("#save_hours_btn").removeClass("ui-disabled ");
                    }
                });
                $("#hours_and_minutes").scroller('setDate', Adate, true);
            });


            function get7LastDescriptions(companyName) {
                var descriptions = tadc.get7descriptions(companyName);
                $("#select_description").children('option').remove();
                $('<option data-placeholder="Description">Description</option>').appendTo($("#select_description"));
                $('<option value="new_description_option">Add new description</option>').appendTo($("#select_description"));
                if(descriptions !== null) {
                    for(var i = 0; i < descriptions.length; i++) {
                        $('<option value="' + descriptions[i] + '" selected="selected">' + descriptions[i] + '</option>').appendTo($("#select_description"));
                        $("#select_description").selectmenu('refresh');
                    }

                }
                $('#select_description').val("Description").selectmenu('refresh');
            }



            $("#select_description").live("change", function() {
                var desc = $("#select_description option:selected").text();
                if(desc === "Day off" || desc === "Time off") {
                    $("#hours_and_minutes").show();
                    $("#first_day_after_vacation").hide();
                    var fullDay = new Date();
                    fullDay.setHours(7);
                    fullDay.setMinutes(30);
                    $("#hours_and_minutes").scroller('setDate', fullDay, true);
                    $("#hours_and_minutes").scroller('destroy');
                    $("#save_hours_btn").removeClass("ui-disabled ");
                } else if(desc === "Add new description") {
                    $("#new_description_link").click();
                } else if(desc === "Vacation") {
                    $("#hours_and_minutes").hide();
                    $("#first_day_after_vacation").show();
                } else {
                    $("#first_day_after_vacation").hide();
                    $("#hours_and_minutes").prop("disabled", false).show();
                }
            });

            function changeDay(nextDay, direction) {
                todaysDate.setDate(todaysDate.getDate()+nextDay);
                $("#date_heading").html(todaysDate.toDateString());
                removeDataInDayList();
                $.mobile.changePage( "#register_hours", {reverse: direction} );
                //addMockData();

            }

            function resetHoursAndMinutes() {

            }

            function removeDataInDayList() {
                var list = document.getElementById("registered_hours_overview");
                if(list.hasChildNodes()) {
                    while(list.childNodes.length >= 1) {
                        list.removeChild(list.firstChild);
                    }
                }
            }

            function changeToSelectedDay(date) {
                todaysDate = date;
                $("#date_heading").html(date.toDateString());
                removeDataInDayList();
                //addMockData();
                //kjør metode for å hente ut lagret data for denne dagen
            }

            function pushData(formObject) {
                var company = $("#select_company option:selected").text();
                var description = $("#select_description option:selected").text();
                if(company !== "Vacation") {
                    var number_of_hours = formatTime($("#hours_and_minutes").val());
                    tadc.updatePunch(company, description, todaysDate, number_of_hours);
                } else {
                    var dateAfterVacation = $("#first_day_after_vacation").val();
                }
            }

            function formatTime(time) {
                var hours = time.slice(0,2);
                var minutes = time.slice(3,5);
                if(hours.slice(0,1) == 0) {
                    hours = hours.slice(1,2);
                }
                switch(minutes) {
                    case '00':
                        minutes = 0;
                        break;
                    case '15':
                        minutes = 25;
                        break;
                    case '30':
                        minutes = 5;
                        break;
                    case '45':
                        minutes = 75;
                        break;
                }
                return hours + "." + minutes;
            }

            function resetFormValues() {
                $('#select_company').val("Company").selectmenu('refresh');
                $('#select_description').val('Description').selectmenu('refresh');
                $("#hours_and_minutes").scroller('setDate', new Date(0,0,0,0,0,0,0), true);
            }

            function addMockLine(jsonString) {
                var jsonObject = JSON.parse(jsonString);
                var company = jsonObject.company;
                var description = jsonObject.description;
                var hours = jsonObject.number_of_hours;
                var kk ='<li> <a href="#add_details" onclick="editDetails()" data-ajax="false"> <h3>' + company + '</h3><p>' + description + " " + hours + '</p></a></li>';

                $('#registered_hours_overview').append(kk);
                $('#registered_hours_overview').listview('refresh');
            }

            function addMockData() {
                var daysData = tadc.getDataForDay(todaysDate);
                var html = '';
                var idCounter = 0;
                for(var i =0; i<daysData.length; i++) {
                    html = '<li> <a href="edit_line.html" id="'+ idCounter +'" onclick="editDetails(this.id)" data-ajax="false"> ' +
                            '<h3 id="company' + idCounter +'">' + daysData[i].name + '</h3>' +
                            '<p id="description' + idCounter +'">' + daysData[i].desc + '</p>' +
                            '<p id="hours'+ idCounter +'">' + daysData[i].totH +" hours" + '</p>' +
                            '</a></li>';
                    idCounter++;

                    $('#registered_hours_overview').append(html);
                    $('#registered_hours_overview').listview('refresh');
                }
            }


            function editDetails(id) {
                var company = $("#company"+id).html();
                var descr = $("#description"+id).html();
                var time = $("#hours"+id).html();
                var index = time.indexOf('hours');
                var timeToSend = time.slice(0, index);
                localStorage.setItem("todaysDate", todaysDate);
                localStorage.setItem("company", company);
                localStorage.setItem("description", descr);
                localStorage.setItem("hours", timeToSend);

            }

            function choseDate() {
                $('#mydate').datebox('open');
            }

        $("#register_hours").live('pageinit', function() {
            //alert("yo");
           //addMockData();
        });

            $("#registered_hours_overview").load(function() {
                addMockData();
            });






        </script>

    </head>
    <body>
        <div data-role="page" id="register_hours">

            <div data-role="content">
                <h2 id="date_heading" onclick="choseDate()"><script type="text/javascript">printDate()</script></h2>
                <input type="date" data-role="datebox" id="mydate"
                       data-options='{"mode" : "calbox","calStartDay" : 1, "noButton": true, "centerWindow":true, "useInlineHideInput":true}' />

                <h2>Register hours</h2>

                <ul data-role="listview" id="registered_hours_overview">
                </ul>

                <br />
                <a href="#add_details" id="add_new_line" data-role="button">Add hours</a>

            </div>
            <!--Add footer from script -->
            <script type="text/javascript" src="js/navbar.js"></script>
        </div>

        <!-- Add punch -->

        <div data-role="page" id="add_details">
            <div data-role="content">
                <form id="details_to_add">
                    <div data-role="fieldcontain">
                        <select id="select_company" data-native-menu="false" value="Company">
                        </select>

                        <select id="select_description" data-native-menu="false" value="Description">
                      </select>
                    </div>

                    <div data-role="fieldcontain">
                        <input type="text" id="hours_and_minutes" placeholder="Hours and minutes" disabled="true"/>
                        <input id="first_day_after_vacation" type="date" placeholder="First day after vacation"
                               style="display: none;"/>
                    </div>
                    <div data-role="controlgroup" data-type="horizontal">
                        <a href="#" data-role="button" data-rel="back">Close</a>
                        <a href="#" data-role="button" id="save_hours_btn" data-rel="back" class="ui-disabled" onclick="pushData()">Save</a>
                    </div>
                </form>
                <a href="#" id="new_description_link" style="display : none;"></a>
                <a id="new_company_link" href="#" style="display: none;"></a>
                <a id="vacation_date" href="#" style="display: none;"></a>
                <a href="#" data-role="button" value="clear" onclick="resetFormValues()">Clear</a>
                <input type="button" onclick="notifyMe()" value="notify"/>
                <input type="date" id="notifyTime"/>
            </div>
        </div>

    <script type="text/javascript">

        function notifyMe() {

            window.plugins.statusBarNotification.notify("Put your title here", "Put your message here");
        }
    </script>

    </body>
</html>