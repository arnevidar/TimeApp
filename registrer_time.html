<!DOCTYPE html>
<html>
    <head>

        <title>Register hours</title>
        <link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.0.css" />
        <link rel="stylesheet" type="text/css" href="css/mobiscroll-1.5.3.css"/>
        <link rel="stylesheet" type="text/css" href="http://dev.jtsage.com/cdn/simpledialog/latest/jquery.mobile.simpledialog.min.css" />
        <link rel="stylesheet" type="text/css" href="http://dev.jtsage.com/cdn/datebox/latest/jquery.mobile.datebox.min.css" />
        <script type="text/javascript" charset="utf-8" src="js/jquery-1.6.4.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/jquery.mobile-1.0.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/jquery.mobile.simpledialog.min.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/mobiscroll-1.5.3.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/jquery.form.js"></script>
        <script type="text/javascript" src="http://dev.jtsage.com/cdn/datebox/latest/jquery.mobile.datebox.min.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/phonegap-1.3.0.js"></script>
        <script type="text/javascript" charset="utf-8">


            var todaysDate = new Date();
            var mockIdCreator = 0;

            $(document).bind('pagecreate', function() {
                $("#mydate").bind('datebox', function (e, passed) {
                    if ( passed.method === 'set' ) {
                        changeToSelectedDay(passed.date);
                    }
                });
            });

            $(document).delegate('#new_description_link', 'click', function() {
                $(this).simpledialog({
                    'mode' : 'string',
                    'prompt' : 'Add a new company',
                    'useDialogForceFalse' : true,
                    'buttons' : {
                        'OK': {
                            click: function () {
                                var newOption = $("#new_description_link").attr('data-string');
                                $('<option value="'+newOption+'" selected="selected">'+newOption+'</option>').appendTo($("#select_company"));
                                $("#select_company").selectmenu('refresh', true);
                                
                            }
                        },
                        'Cancel': {
                            click: function () { },
                            icon: "delete",
                            theme: "c"
                        }
                    }
                })
            });


            $(document).ready(function() {
               var optionsArray = $("#select_description").children('option').map(function() {
                    return {
                        "value": this.value,
                        "option": "<option value='" + this.value + "'>" + this.text + "</option>"
                    }
                })
                $("#select_company").change(function() {
                    $("#select_description").children('option').remove();
                    var internalAlternatives = [];
                    for(var i=0; i<optionsArray.length; i++) {
                        if(optionsArray[i].value.indexOf($(this).val()) > -1) {
                            internalAlternatives.push(optionsArray[i].option);
                        }
                    }
                    $("#select_description").html(internalAlternatives.join(''));
                    var mySelect = $("#select_description");
                    mySelect.selectmenu("refresh");
                }).change();
            });


            function openNewcompanyDialog(obj) {
                //var selected = $("#select_company option:selected");
                var ddValue = obj.value;
                if(ddValue === "new_company_option") {
                    //alert(ddValue);
                 // $("#linkHax").click();
                    $("#new_description_link").click();
                }

            }

            function handleInternalChoice(obj) {
                var ddValue = obj.value;
                if(ddValue === "day_off" || ddValue === "time_off") {
                    $("#internal_back").click();
                  //  $("#save_value").click();
                } else if(ddValue === "new_description_option") {
                    new_description_link.click();
                } else if(ddValue === "vacation") {
                    $("#tester").attr('disabled', 'disabled');
                    //Show datepicker with vacation-stop
                }
            }


            function saveNewCompany() {
                var newCompany = $('#the_new_company').val();
                var company = new Object();
                //company.id = //getcompany.length +1;
                company.value = newCompany;
                var jsonString = JSON.stringify(hours);
                alert(jsonString);
                //Do JSON things to add the company and show as chosen in the selectbox

            }

            function printDate() {
                //var theDate = new Date();
                //theDate.setDate(theDate.getDate()+toTheRight);
               // var today = new Date();
                document.write(todaysDate.toDateString());
            }

            function saveDraft() {
                var formElements = $('#details_to_add :input');
                var value = [];
                formElements.each(function(i, el) {
                     value.push(el.val);
                });
                var message = '';
                for (var num = 0; num < value.length; num++) {
                    message += value[num];
                }
                //alert(message);
                //alert(value.join(' '));
                //do JSON-stuff
            }

            $(document).delegate('[data-role="page"]', 'swipeleft swiperight', function(event) {
                event.preventDefault();
                var direction = 0;
                if(event.type == 'swipeleft') {
                    //show next day
                   direction = +1;
                } else if(event.type == 'swiperight') {
                    //show previous day
                    direction = -1;
                }
                changeDay(direction);
            });

            function changeDay(direction) {
                todaysDate.setDate(todaysDate.getDate()+direction);
                $("#date_heading").html(todaysDate.toDateString());
                $("#transition_left").click();
                //load records from this day and put it in the div, in a li?

            }

            function changeToSelectedDay(date) {
                todaysDate = date;
                $("#date_heading").html(date.toDateString());
                //alert(todaysDate);
                //kjør metode for å hente ut lagret data for denne dagen
            }

            function pushData(formObject) {
                var hours = new Object();
               // hours.id = xx;
                hours.day = todaysDate.getDay(); //0-6. Monday = 1
                hours.company = $("#select_company option:selected").text();
                hours.description = $("#select_description option:selected").text();
                hours.number_of_hours = $("#number_of_hours").val();
                var jsonString = JSON.stringify(hours);
                addMockLine(jsonString);
                resetFormValues();
             //   writefile('hours', hours, onFailure);
            }

            function resetFormValues() {
                $('#select_company option')[0].selected = true;
                $("#select_company").selectmenu('refresh');
                $("#select_company").change();

            }

            function addMockLine(jsonString) {
                var jsonObject = JSON.parse(jsonString);
                var company = jsonObject.company;
                var description = jsonObject.description;
                var hours = jsonObject.number_of_hours;
                var kk ='<li> <a href="#add_details" onclick="editDetails()"> <h3>' + company + '</h3><p>' + description + " " + hours + '</p></li>';
                //alert(kk);

                $('#registered_hours_overview').append(kk);
                $('#registered_hours_overview').listview('refresh');
            }

            function checkContentsOfThisDay() {
                
            }

            function editDetails(company, description) {
                //var object = obj.attr("id");
                //var ll = obj.val();
                //alert(company);
                //alert(description);
                //$("#select_company")
            }

            function choseDate() {
              $('#mydate').datebox('open');
            }

            $(document).ready(function() {
                var Adate = new Date(0,0,0,0,0,0,0);
                $("#hours_and_minutes").scroller({ preset: 'time', hourText: 'Hours',minuteText:'Minutes',
                    stepMinute: 15, ampm: false, timeFormat : 'HH:ii'});
                $("#hours_and_minutes").scroller('setDate', Adate, true);
            });



        </script>

    </head>
    <body>
        <div data-role="page" id="register_hours">

            <div data-role="content">
                <h2 id="date_heading" onclick="choseDate()"><script type="text/javascript">printDate()</script></h2>
                <input type="date" data-role="datebox" id="mydate"
                       data-options='{"mode" : "calbox","calStartDay" : 1, "noButton": true, "centerWindow":true, "useInlineHideInput":true}' />

                <h2>Register hours</h2>
                <ul data-role="listview" id="registered_hours_overview">

                </ul>
                <a href="#add_details" id="add_new_line" data-role="button">Add hours</a>

            </div>
            <!--Add footer from script -->
            <script type="text/javascript" src="js/navbar.js"></script>
        </div>

        <div data-role="page" id="add_details">
            <div data-role="content">
                <form id="details_to_add">
                    <div data-role="fieldcontain">
                        <select id="select_company" data-native-menu="false" onchange="openNewcompanyDialog(this)" value="Company">
                            <option data-placeholder="company">Company</option>
                            <option value=""></option>
                            <option value="test">Test</option>
                            <option value="internal1">Internal</option>
                            <option value="new_company_option">Add a new company</option>
                        </select>
                    </div>

                    <div data-role="fieldcontain">
                        <select id="select_description" data-native-menu="false" onchange="handleInternalChoice(this)" value="Description">
                            <option data-placeholder="description">Description</option>
                            <option value="new_description_option">Add new description</option>

                            <!--Options to be shown when "internal" is chosen from company -->
                            <option value="internal1_1">Day off</option>
                            <option value="internal1_2">Time off</option>
                            <option value="internal1_3">Vacation</option>
                      </select>
                    </div>

                    <div data-role="fieldcontain">
                        <label for="hours_and_minutes">Hours and minutes:</label>
                        <input type="time" id="hours_and_minutes"/>
                        <input type="text" id="tester"/>
                    </div>
                    <div data-role="controlgroup" data-type="horizontal">
                        <a href="#" data-role="button" data-rel="back">Close</a>
                        <a href="#" data-role="button" data-rel="back" onclick="pushData()">Save</a>
                    </div>
                </form>
                <a href="#" id="new_description_link" style="display : none;"></a>
                <a href="#" data-role="button" value="clear" onclick="resetFormValues()">Clear</a>
            </div>
        </div>

        <!--a hack to get the dialog working -->

        <a id="transition_left" href="#" data-transition="slide"></a>
        <a id="linkHax" href="#new_company" data-rel="dialog" data-transition="pop" style="display: none;"></a>
        <a id="internal_link" href="#internal_alternatives" data-rel="dialog" data-transition="pop" style="display:none;"></a>

        <div data-role="page" id="new_company" >
            <div data-role="content">
                <h2>Add a new company</h2>
                <input type="text" id="the_new_company" value="New company"/>
                <div data-role="controllgroup" data-type="horizontal">
                    <a href="#" data-role="button" data-rel="back">Close</a>
                    <a href="#" data-role="button" data-rel="back" onclick="saveNewCompany()">Save</a>
                </div>
            </div>
        </div>
    
        <div data-role="page" id="internal_alternatives">
            <div data-role="content">
                <select id="select_internal_description" data-native-menu="false" onchange="handleInternalChoice(this)">
                    <option value="vacation">Vacation</option>
                    <option value="day_off">Day off</option>
                    <option value="time_off">Time off</option>
                </select>
                <a href="#" id="internal_back" data-role="button" data-rel="back" style="display : none;"></a>
            </div>
        </div>
    </body>
</html>