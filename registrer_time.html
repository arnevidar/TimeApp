<!DOCTYPE html>
<html>
    <head>

        <title>Register hours</title>
        <link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.0.css" />

        <link rel="stylesheet" type="text/css" href="http://dev.jtsage.com/cdn/datebox/latest/jquery.mobile.datebox.min.css" />
        <script type="text/javascript" charset="utf-8" src="js/jquery-1.6.4.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/jquery.mobile-1.0.js"></script>
        <script type="text/javascript" src="http://dev.jtsage.com/cdn/datebox/latest/jquery.mobile.datebox.min.js"></script>
        <script type="text/javascript" src="http://dev.jtsage.com/cdn/datebox/i8n/jquery.mobile.datebox.i8n.en.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/phonegap-1.3.0.js"></script>
        <script type="text/javascript" charset="utf-8">


            var todaysDate = new Date();
            var mockIdCreator = 0;

            $(document).ready(function() {
               var optionsArray = $("#select_description").children('option').map(function() {
                    return {
                        "value": this.value,
                        "option": "<option value='" + this.value + "'>" + this.text + "</option>"
                    }
                })
                $("#select_company").change(function() {
                    $("#select_description").children('option').remove();
                    var internalAlternatives = [];
                    for(var i=0; i<optionsArray.length; i++) {
                        if(optionsArray[i].value.indexOf($(this).val()) > -1) {
                            internalAlternatives.push(optionsArray[i].option);
                        }
                    }
                    $("#select_description").html(internalAlternatives.join(''));
                    var mySelect = $("#select_description");
                    mySelect.selectmenu("refresh");


                }).change();
            });


            function openNewcompanyDialog(obj) {
                //var selected = $("#select_company option:selected");
                var ddValue = obj.value;
                if(ddValue === "new_company_option") {
                    //alert(ddValue);
                  $("#linkHax").click();
                }

            }

            function handleInternalChoice(obj) {
                var ddValue = obj.value;
                if(ddValue === "day_off" || ddValue === "time_off") {
                    $("#internal_back").click();
                  //  $("#save_value").click();
                }
            }


            function saveNewCompany() {
                var newCompany = $('#the_new_company').val();
                var company = new Object();
                //company.id = //getcompany.length +1;
                company.value = newCompany;
                var jsonString = JSON.stringify(hours);
                alert(jsonString);
                //Do JSON things to add the company and show as chosen in the selectbox

            }

            function printDate() {
                //var theDate = new Date();
                //theDate.setDate(theDate.getDate()+toTheRight);
               // var today = new Date();
                document.write(todaysDate.toDateString());
            }

            function saveDraft() {
                var formElements = $('#details_to_add :input');
                var value = [];
                formElements.each(function(i, el) {
                     value.push(el.val);
                });
                var message = '';
                for (var num = 0; num < value.length; num++) {
                    message += value[num];
                }
                //alert(message);
                //alert(value.join(' '));
                //do JSON-stuff
            }

            $(document).delegate('[data-role="page"]', 'swipeleft swiperight', function(event) {
                event.preventDefault();
                var direction = 0;
                if(event.type == 'swipeleft') {
                    //show next day
                   direction = +1;
                } else if(event.type == 'swiperight') {
                    //show previous day
                    direction = -1;
                }
                changeDay(direction);
            });

            function changeDay(direction) {
                todaysDate.setDate(todaysDate.getDate()+direction);
                $("#date_heading").html(todaysDate.toDateString());
                //load records from this day and put it in the div, in a li?

            }

            function pushData() {
                var hours = new Object();
               // hours.id = xx;
                hours.day = todaysDate.getDay(); //0-6. Monday = 1
                hours.company = $("#select_company option:selected").text();
                hours.description = $("#select_description option:selected").text();
                hours.number_of_hours = $("#number_of_hours").val();
                var jsonString = JSON.stringify(hours);
                document.forms['details_to_add'].reset();
                addMockLine(jsonString);
             //   writefile('hours', hours, onFailure);
            }

            function resetFormValues() {

            }

            function addMockLine(jsonString) {
                var jsonObject = JSON.parse(jsonString);
                var company = jsonObject.company;
                var description = jsonObject.description;
                var hours = jsonObject.number_of_hours;
                var kk ='<li> <a href="#add_details" onclick="editDetails()"> <h3>' + company + '</h3><p>' + description + " " + hours + '</p></li>';
                //alert(kk);

                $('#registered_hours_overview').append(kk);
                $('#registered_hours_overview').listview('refresh');
            }

            function checkContentsOfThisDay() {
                
            }

            function editDetails(company, description) {
                //var object = obj.attr("id");
                //var ll = obj.val();
                //alert(company);
                //alert(description);
                //$("#select_company")
            }

            function choseDate() {
                alert("hey");
                //$("#datePickerArea").show();
            }




        </script>

    </head>
    <body>
        <div data-role="page" id="register_hours">

            <div data-role="content">
                <h2 id="date_heading" onclick="choseDate()"><script type="text/javascript">printDate()</script></h2>
               <!-- <input name="mydate" id="mydate" type="date" data-role="datebox" data-options='{"mode": "calbox"}'>
               -->
                <h2>Register hours</h2>
                <ul data-role="listview" id="registered_hours_overview">

                </ul>
                <a href="#add_details" id="add_new_line" data-role="button">Add hours</a>

            </div>
            <div data-role="footer" data-position="fixed">
                <div data-role="navbar">
                    <ul>
                        <li><a href="index.html" data-icon="home">Overview</a></li>
                        <li><a href="registrer_time.html" data-icon="plus">Add hours</a> </li>
                        <li><a href="Pages/settings.html" data-icon="gear">Settings</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div data-role="page" id="add_details">
            <div data-role="content">
                <form id="details_to_add" action="">
                    <div data-role="fieldcontain">
                        <select id="select_company" data-native-menu="false" onchange="openNewcompanyDialog(this)">
                            <label for="select_company"  class="select">Select company:</label>
                            <option data-placeholder="company">Company</option>
                            <option value="internal1">Internal</option>
                            <option value="new_company_option">Add a new company</option>
                        </select>
                    </div>

                    <div data-role="fieldcontain">
                        <select id="select_description" data-native-menu="false" onchange="handleInternalChoice(this)">
                            <option data-placeholder="description">Description</option>'
                            <option value="test">Test</option>

                            <!--Options to be shown when "internal" is chosen from company -->
                            <option value="internal1_1">Day off</option>
                            <option value="internal1_2">Time off</option>
                            <option value="internal1_3">Vacation</option>
                      </select>
                    </div>

                    <div data-role="fieldcontain">
                        <label for="number_of_hours">Number of hours:</label>
                        <input type="range" id="number_of_hours" value="0" min="0" max="24" step="0.25" />
                    </div>
                    <div data-role="controlgroup" data-type="horizontal">
                        <a href="#" data-role="button" data-rel="back">Close</a>
                        <a href="#" data-role="button" data-rel="back" onclick="pushData()">Save</a>
                    </div>
                </form>
            </div>
        </div>

        <!--a hack to get the dialog working -->
        <a id="linkHax" href="#new_company" data-rel="dialog" data-transition="pop" style="display: none;"></a>
        <a id="internal_link" href="#internal_alternatives" data-rel="dialog" data-transition="pop" style="display:none;"></a>

        <div data-role="page" id="new_company" >
            <div data-role="content">
                <h2>Add a new company</h2>
                <input type="text" id="the_new_company" value="New company"/>
                <div data-role="controllgroup" data-type="horizontal">
                    <a href="#" data-role="button" data-rel="back">Close</a>
                    <a href="#" data-role="button" data-rel="back" onclick="saveNewCompany()">Save</a>
                </div>
            </div>
        </div>
    
        <div data-role="page" id="internal_alternatives">
            <div data-role="content">
                <select id="select_internal_description" data-native-menu="false" onchange="handleInternalChoice(this)">
                    <option value="vacation">Vacation</option>
                    <option value="day_off">Day off</option>
                    <option value="time_off">Time off</option>
                </select>
                <a href="#" id="internal_back" data-role="button" data-rel="back" style="display : none;"></a>
            </div>
        </div>
    
    </body>
</html>