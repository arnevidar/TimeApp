<!DOCTYPE html>
<html>
<head>

    <title>Register hours</title>
    <link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.0.css" />
    <link rel="stylesheet" type="text/css" href="css/mobiscroll-1.5.3.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/jquery.mobile.simpledialog.min.css" />
    <script type="text/javascript" charset="utf-8" src="js/jquery-1.7.1.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/jquery.mobile-1.0.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/problemdomain.js"></script>

    <script type="text/javascript" charset="utf-8" src="js/mobiscroll-1.5.3.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/phonegap-1.4.0.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/jquery.mobile.simpledialog.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/statusbarnotification.js"></script>
    <script type="text/javascript" charset="utf-8">


        var tadc = new TimeAppDataController();
        tadc.loadData(function() {}, function() {});


        $("#deleteLine").live('click', function() {
            $(this).simpledialog({
                'mode' : 'bool',
                'prompt' : 'Do you want to delete this record?',
                'useModal': true,
                'buttons' : {
                    'OK': {
                        click: function () {
                            var date = localStorage.getItem("todaysDate");
                            var companyName = localStorage.getItem("company");
                            var description = localStorage.getItem("description");
                            var hours = localStorage.getItem("hours");
                            tadc.deleteRecord(companyName, description, date, hours);
                            resetFormValues();
                            $("#close_btn").click();


                        }
                    },
                    'Cancel': {
                        click: function () {
                            //Do nothing, just close the dialog
                        },
                        icon: "delete",
                        theme: "c"
                    }
                }
            })
        });

        $("#new_company_link").live("click", function() {
            $(this).simpledialog({
                'mode' : 'string',
                'prompt' : 'Add a new company',
                'useDialogForceFalse' : true,
                'buttons' : {
                    'OK': {
                        click: function () {
                            var newOption = $("#new_company_link").attr('data-string').trim();
                            if(newOption !== "") {
                                $('<option value="'+newOption+'" selected="selected">'+newOption+'</option>').appendTo($("#select_company"));
                                $("#select_company").selectmenu('refresh');
                                $("#select_company").trigger('change');
                            } else {
                                alert("Not a valid company name");
                            }

                        }
                    },
                    'Cancel': {
                        click: function () { },
                        icon: "delete",
                        theme: "c"
                    }
                }
            })
        });

        $("#new_description_link").live('click', function() {
            $(this).simpledialog({
                'mode' : 'string',
                'prompt' : 'Add a new description',
                'useDialogForceFalse' : true,
                'buttons' : {
                    'OK': {
                        click: function () {
                            var newOption = $("#new_description_link").attr('data-string').trim();
                            if(newOption !== "") {
                                $('<option value="'+newOption+'" selected="selected">'+newOption+'</option>').appendTo($("#select_description"));
                                $("#select_description").selectmenu('refresh');
                                $("#select_description").trigger('change');
                            } else {
                                alert("Not a valid description");
                            }
                        }
                    },
                    'Cancel': {
                        click: function () { },
                        icon: "delete",
                        theme: "c"
                    }
                }
            })
        });



        /**
         * Formats the number hh.MM to hh:MM
         * MM
         * @param number
         */
        function numberToMinute(number) {
            var minute = 0;
            switch(number) {
                case '25':
                    minute = 15;
                    break;
                case '5':
                    minute = 30;
                    break;
                case '75':
                    minute = 45;
                    break;
            }
            return minute;
        }


        /** Get's the 7 last used companies and descriptions.
        ** Then sets the value to the item which is to be edited
        **/
        $("#edit_details").live("pageinit", function() {
            var companyToEdit = localStorage.getItem("company");
            var last7UsedCompanies = tadc.get7companies();
            $("#select_company").children('option').remove();
            $('<option data-placeholder="Company">Company</option>').appendTo($("#select_company"));
            $('<option value="new_company_option">Add a new company</option>').appendTo($("#select_company"));
            $('<option value="Internal">Internal</option>').appendTo($("#select_company"));
            for(var i = 0; i < last7UsedCompanies.length; i++) {
                $('<option value="'+last7UsedCompanies[i] +'" selected="selected">'+last7UsedCompanies[i]+'</option>').appendTo($("#select_company"));
                $("#select_company").selectmenu('refresh');
            }
            $("#select_company").val(companyToEdit).selectmenu('refresh');

            var desc = localStorage.getItem("description");
            var descriptions = tadc.get7descriptions(companyToEdit);
            $("#select_description").children('option').remove();
            $('<option data-placeholder="Description">Description</option>').appendTo($("#select_description"));
            $('<option value="new_description_option">Add new description</option>').appendTo($("#select_description"));
            if(descriptions !== null) {
                for(var i = 0; i < descriptions.length; i++) {
                    $('<option value="' + descriptions[i] + '" selected="selected">' + descriptions[i] + '</option>').appendTo($("#select_description"));
                    $("#select_description").selectmenu('refresh');
                }
            }
            $('#select_description').val(desc).selectmenu('refresh');

            $("#hours_and_minutes").scroller({ preset: 'time', hourText: 'Hours',minuteText:'Minutes',
                stepMinute: 15, ampm: false, timeFormat : 'HH:ii',
                onSelect: function(valueText, inst) {
                    $("#save_hours_btn").removeClass("ui-disabled ");
                }
            });
            var time = localStorage.getItem("hours").split(".");
            var hours = time[0];
            var minutes = numberToMinute(time[1].trim());
            var theTime = new Date();
            theTime.setHours(hours);
            theTime.setMinutes(minutes);
            $("#hours_and_minutes").scroller('setDate', theTime, true);
        });



        $("#select_company").live("change", function() {
            var companyName = $("#select_company option:selected").text();
            if(companyName === "Add a new company") {
                $("#new_company_link").click();
            }
            else if(companyName !== "Company") {
                get7LastDescriptions(companyName);
            }
        });




        function get7LastDescriptions(companyName) {
            var descriptions = tadc.get7descriptions(companyName);
            $("#select_description").children('option').remove();
            $('<option data-placeholder="Description">Description</option>').appendTo($("#select_description"));
            $('<option value="new_description_option">Add new description</option>').appendTo($("#select_description"));
            if(descriptions !== null) {
                for(var i = 0; i < descriptions.length; i++) {
                    $('<option value="' + descriptions[i] + '" selected="selected">' + descriptions[i] + '</option>').appendTo($("#select_description"));
                    $("#select_description").selectmenu('refresh');
                }
            }
            $('#select_description').val("Description").selectmenu('refresh');
        }



        $("#select_description").live("change", function() {
            var desc = $("#select_description option:selected").text();
            if(desc === "Day off" || desc === "Time off") {
                $("#hours_and_minutes").show();
                $("#first_day_after_vacation").hide();
                var fullDay = new Date();
                fullDay.setHours(7);
                fullDay.setMinutes(30);
                $("#hours_and_minutes").scroller('setDate', fullDay, true);
                $("#hours_and_minutes").scroller('destroy');
                $("#save_hours_btn").removeClass("ui-disabled ");
            } else if(desc === "Add new description") {
                $("#new_description_link").click();
            } else if(desc === "Vacation") {
                $("#hours_and_minutes").hide();
                $("#first_day_after_vacation").show();
            } else {
                $("#first_day_after_vacation").hide();
                $("#hours_and_minutes").prop("disabled", false).show();
                $("#save_hours_btn").removeClass("ui-disabled ");
            }
        });

        function resetFormValues() {
            $('#select_company').val("Company").selectmenu('refresh');
            $('#select_description').val('Description').selectmenu('refresh');
            $("#hours_and_minutes").scroller('setDate', new Date(0,0,0,0,0,0,0), true);

        }

        function formatTime(time) {
            var hours = time.slice(0,2);
            var minutes = time.slice(3,5);
            if(hours.slice(0,1) == 0) {
                hours = hours.slice(1,2);
            }
            switch(minutes) {
                case '00':
                    minutes = 0;
                    break;
                case '15':
                    minutes = 25;
                    break;
                case '30':
                    minutes = 5;
                    break;
                case '45':
                    minutes = 75;
                    break;
            }
            return hours + "." + minutes;
        }

        function updateLine() {
            var newCompanyName = $("#select_company option:selected").text();
            var newDescription = $("#select_description option:selected").text();
            var oldCompanyName = localStorage.getItem("company");
            var oldDescription = localStorage.getItem("description");
            var date = localStorage.getItem("todaysDate");
            if(newCompanyName !== "Vacation") {
                var oldHours = localStorage.getItem("hours");
                var newHours = formatTime($("#hours_and_minutes").val());
                tadc.updatePunch(newCompanyName, newDescription, date, newHours, oldCompanyName, oldDescription, date, oldHours);
            } else {
                var dateAfterVacation = $("#first_day_after_vacation").val();
            }
            resetFormValues();
        }



    </script>
</head>

<body>

<div data-role="page" id="edit_details">
    <div data-role="content">
            <div data-role="fieldcontain">
                <select id="select_company" data-native-menu="false" value="Company">
                </select>

                <select id="select_description" data-native-menu="false" value="Description">
                </select>
            </div>

            <div data-role="fieldcontain">
                <input type="text" id="hours_and_minutes"/>
                <input id="first_day_after_vacation" type="date" placeholder="First day after vacation"
                       style="display: none;"/>
            </div>
            <div data-role="controlgroup" data-type="horizontal">
                <a href="#" data-role="button" id="deleteLine">Delete</a>
                <a href="#" data-role="button" data-rel="back">Close</a>
                <a href="#" data-role="button" id="save_hours_btn" data-rel="back" class="ui-disabled" onclick="updateLine()">Save</a>
            </div>
        <a href="#" id="new_description_link" style="display : none;"></a>
        <a id="new_company_link" href="#" style="display: none;"></a>
        <a id="vacation_date" href="#" style="display: none;"></a>
    </div>
</div>




</body>
</html>